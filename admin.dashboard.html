<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Admin Dashboard</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js for views graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Loads Firebase app + PRODUCT_DATA + helpers -->
    <script type="module" src="app.js"></script>

    <!-- AUTH GUARD SCRIPT -->
    <script type="module">
      import {
        getAuth,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import { app } from "./app.js";

      const auth = getAuth(app);

      // Ensure only logged-in users can view this page
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "admin-login.html";
        }
      });

      // Logout helper
      window.adminLogout = function () {
        signOut(auth).then(() => {
          window.location.href = "admin-login.html";
        });
      };
    </script>
  </head>

  <body class="p-4">
    <div class="container">
      <h1 class="mb-4">Store â€” Admin Dashboard</h1>

      <!-- ========================= -->
      <!--       SITE STATISTICS     -->
      <!-- ========================= -->
      <div class="row mb-4">
        <!-- Total Views Card -->
        <div class="col-md-4 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-1">Total Site Views</h5>
              <p class="text-muted small mb-1">
                All public page loads logged in Firestore.
              </p>
              <p id="viewCount" class="fs-3 fw-bold mb-0">0</p>
            </div>
          </div>
        </div>

        <!-- Views Chart -->
        <div class="col-md-8 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Views (Last 7 Days)</h5>
              <canvas id="viewsChart" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-5" />

      <a href="index.html" class="btn btn-secondary mt-4">Back to Store</a>
      <button class="btn btn-danger mt-4" onclick="adminLogout()">Logout</button>
    </div>

    <!-- ADMIN PAGE SCRIPT: VIEWS COUNTER + GRAPH ONLY -->
    <script type="module">
      import {
        getFirestore,
        doc,
        onSnapshot,
        collection,
        getDocs
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      // Use the default Firebase app (initialized in app.js)
      const db = getFirestore();

      /*****************************
       *   SITE VIEW COUNTER       *
       *****************************/
      const viewCountEl = document.getElementById("viewCount");

      onSnapshot(doc(db, "store", "stats"), (snap) => {
        const data = snap.data() || {};
        const views =
          typeof data.pageViews === "number" ? data.pageViews : 0;
        if (viewCountEl) {
          viewCountEl.textContent = views.toLocaleString();
        }
      });

      /*****************************
       *    VIEWS GRAPH (7 DAYS)   *
       *****************************/
      const viewsChartCanvas = document.getElementById("viewsChart");
      let viewsChart = null;

      async function loadViewsGraph() {
        if (!viewsChartCanvas || !window.Chart) return;

        try {
          const eventsRef = collection(db, "viewEvents");

          // Get ALL viewEvents
          const snap = await getDocs(eventsRef);

          // Build last 7 days date range
          const now = new Date();
          const start = new Date();
          start.setHours(0, 0, 0, 0);
          start.setDate(start.getDate() - 6);

          // Prepare buckets: one per day
          const countsByDay = {};
          const days = [];

          for (let i = 0; i < 7; i++) {
            const d = new Date(start);
            d.setDate(start.getDate() + i);
            const key = d.toISOString().slice(0, 10);
            countsByDay[key] = 0;
            days.push(new Date(d));
          }

          snap.forEach((docSnap) => {
            const data = docSnap.data();

            let d;
            if (data.createdAt?.toDate) {
              d = data.createdAt.toDate();
            } else {
              d = new Date(); // treat missing as today
            }

            // Local midnight bucket key
            const localKey = new Date(
              d.getFullYear(),
              d.getMonth(),
              d.getDate()
            )
              .toISOString()
              .slice(0, 10);

            if (d >= start && d <= now && countsByDay[localKey] !== undefined) {
              countsByDay[localKey]++;
            }
          });

          const labels = days.map((d) => d.toLocaleDateString());
          const dataPoints = days.map((d) => {
            const key = d.toISOString().slice(0, 10);
            return countsByDay[key] || 0;
          });

          const highest = Math.max(...dataPoints);
          const suggestedMax = highest <= 0 ? 2 : highest + 2;

          const ctx = viewsChartCanvas.getContext("2d");

          if (viewsChart) {
            viewsChart.destroy();
          }

          viewsChart = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Page Views",
                  data: dataPoints,
                  tension: 0.3,
                  fill: true
                }
              ]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0,
                    stepSize: 1
                  },
                  suggestedMax
                }
              }
            }
          });
        } catch (err) {
          console.error("Error loading views graph:", err);
        }
      }

      loadViewsGraph();
    </script>
  </body>
</html>
